#*Note: Spring Boot automatically maps environment variables like `VAULT_URI` to `vault.uri`.*
#  *   **Command-Line Arguments:**
#         java -jar your-app.jar --vault.uri=http://localhost:8200 --vault.token=s.YourToken
#
#  Your VaultConfig.java is ready. You just need to:
#         1.Start your Vault container (e.g., docker run -p 8200:8200 --cap-add=IPC_LOCK -e 'VAULT_DEV_ROOT_TOKEN_ID=myroot' vault).
#         2.Note the Vault address (usually http://localhost:8200 if accessing from the host) and the root token (e.g., myroot in the example command, or the one Vault prints).
#         3.Provide these values to your Spring Boot application using one of the methods above (properties file, environment variables, etc.) for the vault.uri and vault.token properties.

services:
  the-spring-app:
    image: amlume-shop
    container_name: amlume-shop
    environment:
      VAULT_URI: http://vault:8200 # Assumes vault service name is 'vault'
      VAULT_TOKEN: hvs.95eba8ed-f6fc-958a-f490-c7fd0eda5e9e
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/amlume_db
      SPRING_DATASOURCE_USERNAME: amlume_user
      SPRING_DATASOURCE_PASSWORD: C0961F7D8F83574BEA49E9B412BBA60704CD720C
      CACHE_HOST: valkey-cache
    depends_on:
      - mysql
      - valkey-cache
    networks:
      - amlume-shop-network

  vault:
    image: hashicorp/vault:latest # Or pin to a specific version like 1.16.1
    container_name: vault-dev
    ports:
      - "8200:8200" # Map host port 8200 to container port 8200
    environment:
      # --- Vault Dev Mode Configuration ---
      # Sets the root token ID. Use this value for 'vault.token' in your Spring app.
      # WARNING: This is for development ONLY. Keep it secure.
      VAULT_DEV_ROOT_TOKEN_ID: "95eba8ed-f6fc-958a-f490-c7fd0eda5e9e"

      # Makes Vault listen on all interfaces inside the container
      VAULT_DEV_LISTEN_ADDRESS: "0.0.0.0:8200"

      # --- Optional: Set VAULT_ADDR for CLI inside the container ---
      # VAULT_ADDR: "http://127.0.0.1:8200" # Usually needed if you exec into the container

    cap_add:
      # Required for Vault to lock memory pages (prevents swapping sensitive data)
      - IPC_LOCK
    volumes:
      # --- Optional: Persistence (Uncomment if you want data to survive restarts) ---
      # Note: Dev mode primarily uses in-memory storage. For file storage in dev:
      # Add '-dev -dev-root-token-id="my-dev-root-token" -dev-listen-address="0.0.0.0:8200" -config=/vault/config/local.json' to command
      # And mount a config file + data directory.
      # For a more production-like setup, use a proper backend (like file, consul, postgres etc.) and don't run in dev mode.
      # - ./vault-data:/vault/file # Example for file backend persistence
      - vault_logs:/vault/logs # Optional: Persist logs
    # command: vault server -dev # This is the default for the image, usually not needed explicitly
    networks:
      - amlume-shop-network
   # ... other vault config ...

  mysql:
    image: mysql:lts
    container_name: mysql-db
    ports:
      - "3306:3306"
    environment:
      MYSQL_ROOT_PASSWORD: 7D3212C359485FBF140ABBEBFF4A09CFAB1C0F98
      MYSQL_DATABASE: amlume_db
      MYSQL_USER: amlume_user
      MYSQL_PASSWORD: C0961F7D8F83574BEA49E9B412BBA60704CD720C
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - amlume-shop-network

  valkey-cache:
    image: valkey/valkey:latest
    container_name: valkey-cache
    ports:
      - "6379:6379"
    networks:
      - amlume-shop-network

    # Add other required services here

volumes:
  vault_logs: {}
  mysql_data: {}

networks:
  amlume-shop-network:
    name: amlume-shop-network
